# Chief TUI - Progress Log

## Codebase Patterns

- Use `/chief` (with leading slash) in .gitignore for the root binary to avoid ignoring `cmd/chief/` directory
- Directory structure: `cmd/chief/` for main binary, `internal/` for packages, `embed/` for embedded assets
- Claude's stream-json format: use `--output-format stream-json --verbose` with `-p` flag
- Use json.RawMessage for partial JSON parsing when structure varies (e.g., content blocks)
- Embed assets: use `embed/` package with //go:embed directive, use {{PLACEHOLDER}} syntax for substitution
- File watching: use fsnotify for filesystem changes, send events through channels, only notify on status field changes

---

## 2026-01-25 - US-001
- What was implemented:
  - Initialized Go module at github.com/minicodemonkey/chief
  - Added Bubble Tea, Lip Gloss, and Bubbles dependencies
  - Created directory structure: cmd/chief/, internal/loop/, internal/prd/, internal/tui/, internal/notify/, embed/
  - Created minimal main.go with Hello World Bubble Tea app
  - Verified `go build ./cmd/chief` produces working binary
  - Verified typecheck passes with `go vet ./...`
- Files changed:
  - go.mod, go.sum (new)
  - cmd/chief/main.go (new)
  - .gitignore (new)
- **Learnings for future iterations:**
  - Be careful with .gitignore patterns - `chief` would match both the binary AND `cmd/chief/` directory. Use `/chief` to only match root-level binary
  - Go doesn't track empty directories, so internal subdirs only appear in git when files are added
  - The Hello World app uses standard Bubble Tea pattern: Init(), Update(), View() methods
---

## 2026-01-25 - US-002
- What was implemented:
  - Created internal/prd/types.go with PRD and UserStory structs matching the prd.json schema
  - Created internal/prd/loader.go with LoadPRD(path) and Save(path) methods
  - Added PRD.AllComplete() bool method that returns true when all stories pass
  - Added PRD.NextStory() *UserStory method that prioritizes inProgress stories, then lowest priority
  - Comprehensive unit tests covering all edge cases (empty PRD, all complete, interrupted story, priority ordering)
- Files changed:
  - internal/prd/types.go (new)
  - internal/prd/loader.go (new)
  - internal/prd/prd_test.go (new)
- **Learnings for future iterations:**
  - NextStory() should always check for inProgress stories first (handles interrupted work)
  - Use `json:"inProgress,omitempty"` to avoid outputting false values in JSON (cleaner output)
  - Go test pattern: use t.TempDir() for test file operations - auto-cleaned up after test
  - The PRD struct returns pointers to UserStory to allow nil checks for "no story available"
---

## 2026-01-25 - US-003
- What was implemented:
  - Created internal/loop/parser.go with EventType constants (IterationStart, AssistantText, ToolStart, ToolResult, StoryStarted, StoryCompleted, Complete, MaxIterationsReached, Error)
  - Created Event struct with fields: Type, Iteration, Text, Tool, ToolInput, StoryID, Err
  - Implemented ParseLine(line string) *Event function that parses Claude's stream-json format
  - Added detection for <chief-complete/> tag to return Complete event
  - Added detection for <ralph-status> tags to track story progress
  - Extracts tool name and input from tool_use content blocks
  - Parses tool results from user messages
  - Comprehensive unit tests with real-world example stream-json lines
- Files changed:
  - internal/loop/parser.go (new)
  - internal/loop/parser_test.go (new)
- **Learnings for future iterations:**
  - Claude's stream-json output requires `--verbose` flag when using `-p` (print mode)
  - The stream-json format has three main message types: "system" (init), "assistant" (text/tool_use), "user" (tool_result)
  - Assistant messages can have multiple content blocks - parser returns the first meaningful event
  - Use json.RawMessage for nested structures to handle varying content block types
  - The extractStoryID helper uses string indices rather than regex for simplicity and performance
---

## 2026-01-25 - US-004
- What was implemented:
  - Created internal/loop/loop.go with Loop struct containing: prdPath, prompt, maxIter, iteration, events chan, claudeCmd, logFile, mu, stopped
  - Implemented Run(ctx context.Context) error that loops until complete or max iterations
  - Implemented runIteration(ctx context.Context) error that spawns Claude with flags: --dangerously-skip-permissions, -p, --output-format stream-json, --verbose
  - Streams stdout line by line, parses each line with ParseLine(), sends events to channel
  - Logs raw output to claude.log file in PRD directory
  - Implemented Stop() method that kills the Claude process and sets stopped flag
  - Checks prd.json after each iteration to detect completion using PRD.AllComplete()
  - Created comprehensive integration tests with mock data
- Files changed:
  - internal/loop/loop.go (new)
  - internal/loop/loop_test.go (new)
- **Learnings for future iterations:**
  - Use bufio.Scanner with increased buffer size (1MB) for parsing large JSON lines from Claude
  - The Loop struct uses a mutex to protect claudeCmd and iteration during concurrent access
  - Use exec.CommandContext for automatic process cancellation when context is cancelled
  - Set working directory of Claude process to PRD directory so relative paths work correctly
  - The events channel has a buffer (100) to prevent blocking during high-frequency event emission
  - When testing file-based logic, use t.TempDir() for automatic cleanup
---

## 2026-01-25 - US-005
- What was implemented:
  - Created embed/prompt.txt with the agent prompt that instructs Claude how to work through user stories
  - Created embed/embed.go with //go:embed directive to embed the prompt at compile time
  - Implemented GetPrompt(prdPath string) function that substitutes {{PRD_PATH}} placeholder with actual path
  - Added NewLoopWithEmbeddedPrompt(prdPath, maxIter) constructor to internal/loop/loop.go
  - Created comprehensive unit tests for the embed package
  - Prompt includes all required instructions: read prd.json, select next story, set inProgress, implement, mark passes, append to progress.md, output <chief-complete/> when done
- Files changed:
  - embed/prompt.txt (new)
  - embed/embed.go (new)
  - embed/embed_test.go (new)
  - internal/loop/loop.go (modified - added NewLoopWithEmbeddedPrompt function)
- **Learnings for future iterations:**
  - Go's //go:embed directive embeds file content at compile time, making it available as a string variable
  - Use underscore import (`_ "embed"`) when using //go:embed with a package-level string variable
  - The embedded prompt uses {{PRD_PATH}} as a placeholder for string substitution with strings.ReplaceAll
  - Keep the embed package separate from internal packages to allow clean imports
---

## 2026-01-25 - US-006
- What was implemented:
  - Created internal/tui/app.go with main Bubble Tea model containing App struct with state, iteration tracking, PRD data
  - Created internal/tui/dashboard.go with two-panel layout (Stories list + Details panel)
  - Created internal/tui/styles.go with basic Lip Gloss style definitions and status icons
  - Stories panel shows: status icon (checkmark/dot/circle), story ID, truncated title with selection highlight
  - Details panel shows: full title, description, acceptance criteria list, priority and status
  - Header shows: "chief" branding, state indicator with colors (Ready/Running/etc), iteration count, elapsed time
  - Footer shows: keyboard shortcuts (up/k, down/j, q), current PRD name
  - Progress bar at bottom of stories panel showing completion percentage with filled/empty bars
  - Keyboard navigation: up/k moves selection up, down/j moves selection down, q quits
  - Updated cmd/chief/main.go to use the new TUI package with PRD path argument support
- Files changed:
  - internal/tui/app.go (new)
  - internal/tui/dashboard.go (new)
  - internal/tui/styles.go (new)
  - cmd/chief/main.go (modified)
- **Learnings for future iterations:**
  - lipgloss.Color is a type, not a style - use lipgloss.NewStyle().Foreground(color) to render text with a color
  - Bubble Tea uses tea.WithAltScreen() for full-screen TUI applications
  - The App struct needs width/height from tea.WindowSizeMsg to properly render layouts
  - Use lipgloss.JoinHorizontal/JoinVertical for composing UI elements
  - Text wrapping needs to be handled manually - created wrapText helper function
  - Panel borders take up 2 characters of width (1 each side), account for this in width calculations
---

## 2026-01-25 - US-007
- What was implemented:
  - Added loop control methods to internal/loop/loop.go: Pause(), Resume(), IsPaused(), IsStopped(), IsRunning()
  - Modified Loop.Run() to check pause flag and stop cleanly when paused
  - Integrated Loop with App in internal/tui/app.go using context for cancellation
  - Added keyboard handlers: 's' to start, 'p' to pause, 'x' to stop
  - Added LoopEventMsg and LoopFinishedMsg custom Bubble Tea messages for loop events
  - Added activity line at bottom of dashboard showing current Claude activity
  - Context-sensitive footer shortcuts based on current state
  - Unit tests for state machine transitions in state_test.go
- Files changed:
  - internal/loop/loop.go (modified - added pause methods)
  - internal/tui/app.go (modified - added loop integration, keyboard handlers, event handling)
  - internal/tui/dashboard.go (modified - added activity line, context-sensitive shortcuts)
  - internal/tui/state_test.go (new)
- **Learnings for future iterations:**
  - Use tea.Batch() to run multiple commands concurrently (e.g., runLoop + listenForEvents)
  - Custom messages (LoopEventMsg, LoopFinishedMsg) allow clean separation of loop events from UI
  - The loop's Events() channel should be read in a separate command to avoid blocking the UI
  - State transitions in Update() should return immediately with new commands for async operations
  - Context with cancel is essential for clean shutdown of the loop goroutine
  - Footer shortcuts should be context-sensitive to guide users to valid actions
---

## 2026-01-25 - US-008
- What was implemented:
  - Created internal/prd/watcher.go with Watcher struct for file watching using fsnotify
  - Watcher monitors prd.json for filesystem changes and sends WatcherEvent through a channel
  - Added hasStatusChanged() method to detect when a story's inProgress or passes field changes
  - Integrated watcher with TUI app in internal/tui/app.go
  - Added PRDUpdateMsg custom Bubble Tea message for PRD file changes
  - Watcher starts on app Init() and listens for changes concurrently
  - Handles file not found gracefully (sends error event, tries to re-watch)
  - Updates story icons in real-time when file changes
  - Created comprehensive integration tests for file watching functionality
- Files changed:
  - go.mod, go.sum (modified - added fsnotify dependency)
  - internal/prd/watcher.go (new)
  - internal/prd/watcher_test.go (new)
  - internal/tui/app.go (modified - added watcher integration)
- **Learnings for future iterations:**
  - fsnotify requires explicit handling of file removal (try to re-add watch for potential recreation)
  - Use WatcherEvent struct with both PRD and Error fields to communicate success/failure
  - Only send PRD change events when status fields actually change (avoid noise from description edits)
  - The hasStatusChanged() method maps old stories by ID for efficient comparison
  - Watcher uses a buffered channel (10) to prevent blocking during rapid file changes
  - Always stop the watcher on app quit to release file handles
---

